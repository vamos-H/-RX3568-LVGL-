# 基于RK3568的C语言联机中国象棋项目操作手册

本操作手册旨在为您的基于C语言、LVGL图形库和瑞芯微RK3568开发板的中国象棋项目提供从代码理解、环境配置到编译部署的完整指南。

由于这是一个嵌入式项目，其操作流程与普通PC软件开发有所不同，核心在于**交叉编译**和**硬件适配**。

-----

## 第一章：环境准备与核心依赖

在开始编译和运行代码之前，需要确保宿主机（用于编译的电脑，通常是PC/Linux）和目标机（RK3568开发板）的环境满足要求。

| 类别 | 依赖项 | 描述 | 备注 |
| :--- | :--- | :--- | :--- |
| **宿主机软件** | **交叉编译工具链** | 适用于RK3568架构（ARM Cortex-A55）的`aarch64-linux-gnu-gcc`工具链。 | 必须是支持目标平台架构（ARM64/aarch64）的工具链。 |
| | **CMake/Make** | 用于管理项目构建过程。 | 建议采用CMake。 |
| | **Git** | 用于版本控制和获取代码。 | |
| | **SSH/SCP 客户端** | 用于远程登录到RK3568，以及传输编译好的可执行文件。 | 如PuTTY、MobaXterm、或Linux/macOS自带的`ssh`。 |
| **目标机硬件** | **RK3568 开发板** | 确保开发板已启动，并运行嵌入式Linux系统。 | |
| **目标机配置** | **网络连接** | 宿主机和RK3568需要在同一局域网内，以实现联机和文件传输。 | 确保以太网或Wi-Fi配置正确 [1]。 |
| | **Frame Buffer/DRM** | 确保RK3568系统已启用并暴露了帧缓冲区或DRM接口供LVGL使用。 | LVGL在Linux下常通过`/dev/fb0`或`DRM/KMS`进行显示。 |

-----

## 第二章：项目代码结构分析

您的项目代码应遵循清晰的模块化结构，以便于定位、修改和维护各个子系统（游戏逻辑、UI、网络）。

| 目录/文件 | 模块职责 | 核心内容 | 关键配置点 |
| :--- | :--- | :--- | :--- |
| `main.c` | **系统入口与主循环** | 初始化LVGL、网络、游戏状态机 [2]。包含嵌入式系统的“控制循环”（Control Loop）[3, 4]。 | LVGL初始化、主循环调用（如`lv_timer_handler()`）。 |
| `src/game_logic/` | **核心游戏逻辑** | 中国象棋规则（走子判断、将军、将死判定）、棋盘状态数据结构。 | 走子算法、状态机定义（`enum`或`struct`）[5, 2]。 |
| `src/ui_lvgl/` | **图形用户界面（GUI）** | LVGL对象（棋盘、棋子`Image` [6]、按钮`Widget`）、事件回调函数 [7, 8]。 | 屏幕分辨率、棋子资源路径、事件处理逻辑。 |
| `src/network/` | **多人联机通信** | TCP/IP套接字创建、连接管理、数据包的打包和解析 [1]。实现自定义的轻量级通信协议。 | 服务器IP地址、端口号、数据包序列化格式。 |
| `lib/lvgl/` | **LVGL 库文件** | LVGL源代码和驱动文件。 | |
| `configs/` | **配置文件** | 包含`lv_conf.h`（LVGL配置）和`net_config.h`（网络配置）。 | **必须修改**以适配RK3568屏幕尺寸和网络环境。 |
| `CMakeLists.txt` | **构建系统文件** | 定义编译规则、链接库（如LVGL、`pthreads`、`sockets`）。 | 交叉编译工具链配置。 |

-----

## 第三章：关键配置与修改指南

在编译之前，您需要根据RK3568的实际运行环境修改以下关键配置文件。

### **3.1 LVGL显示与性能配置（`configs/lv_conf.h`）**

此文件决定了GUI的显示效果和内存占用。

1.  **修改显示分辨率：**

    ```c
    #define LV_HOR_RES_MAX  480    // 根据您的显示屏实际水平分辨率进行设置（例如：1024）
    #define LV_VER_RES_MAX  272    // 根据您的显示屏实际垂直分辨率进行设置（例如：600）
    ```

2.  **配置显示缓冲区：**
    为了实现流畅的动画效果，建议启用双缓冲机制 [9, 10]。

    ```c
    // 定义至少1/10屏幕大小的缓冲区，或两个全屏幕大小的缓冲区以实现双缓冲
    #define LV_MEM_CUSTOM 0
    //...
    #define LV_USE_DRAW_BUF 1
    //...
    //... 配置双缓冲相关的宏...
    ```

3.  **启用所需功能：**
    确保启用了所有需要的小部件（Widgets）、动画（Animation）和抗锯齿（Anti-aliasing）等功能。

### **3.2 网络连接配置（`src/network/net_config.h`）**

此文件定义了联机模式下的连接参数。

1.  **定义端口号：**

    ```c
    #define GAME_PORT 8888  // 用于建立TCP连接的端口号
    ```

2.  **配置联机模式（主机/客户端）：**
    联机象棋需要一台设备作为“服务器”（主机）等待连接，另一台作为“客户端”发起连接。

      * **作为主机（Server）：**
        ```c
        #define IS_HOST_MODE 1
        #define HOST_IP      "0.0.0.0" // 监听所有地址
        ```
      * **作为客户端（Client）：**
        ```c
        #define IS_HOST_MODE 0
        #define HOST_IP      "192.168.1.100" // 填写主机（另一台RK3568或PC）的IP地址
        ```
      * *注：* 建议在代码中设计命令行参数或运行时配置，避免每次切换模式都修改代码。

-----

## 第四章：编译、部署与运行

### **4.1 交叉编译（Cross-Compilation）**

您不能直接在RK3568上编译，必须在宿主机上使用交叉编译工具链针对目标架构生成可执行文件。

1.  **设置编译环境：**
    确保您的交叉编译工具链路径已添加到系统的环境变量`$PATH`中。

2.  **创建和配置CMake工具链文件：**
    通常需要一个`toolchain.cmake`文件来指导CMake使用正确的交叉编译器。

    ```cmake
    # toolchain.cmake 示例
    SET(CMAKE_SYSTEM_NAME Linux)
    SET(CMAKE_SYSTEM_PROCESSOR aarch64)
    # 替换为您的工具链路径
    SET(TOOLCHAIN_PREFIX aarch64-linux-gnu-) 
    SET(CMAKE_C_COMPILER /path/to/your/toolchain/bin/${TOOLCHAIN_PREFIX}gcc)
    #... 其他配置...
    ```

3.  **执行编译流程：**
    在项目根目录下创建一个`build`目录，执行编译命令：

    ```bash
    mkdir build
    cd build
    # 使用toolchain文件指导交叉编译
    cmake.. -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake
    make -j$(nproc)
    ```

    成功后，您将在`build`目录下获得一个可执行文件，例如`chess_game`。

### **4.2 部署到RK3568**

使用SCP（Secure Copy Protocol）将可执行文件传输到RK3568开发板的某个目录下。

1.  **传输文件：**
    ```bash
    # 假设RK3568的IP是 192.168.1.10，用户名为 root
    scp./build/chess_game root@192.168.1.10:/usr/bin/
    ```

### **4.3 运行与测试**

1.  **通过SSH登录目标板：**

    ```bash
    ssh root@192.168.1.10
    ```

2.  **运行程序：**

      * **作为主机（Server）运行：**
        ```bash
        # 必须先运行主机，监听连接
        ```

    ./chess\_game --host
    \`\`\`

      * **作为客户端（Client）运行：**
        ```bash
        # 运行客户端，尝试连接主机IP
        ```

    ./chess\_game --client
    \`\`\`

3.  **UI/网络测试：**

      * **UI测试：** 确认LVGL界面能正确显示，且触摸输入（如选中棋子）能通过LVGL事件机制 [7]触发相应回调。
      * **联机测试：** 在两台设备上分别运行主机和客户端模式，执行走子操作，确认对端屏幕上的棋盘状态能同步更新（数据包发送/接收成功）。

-----

## 第五章：状态机与调试（高级）

### **5.1 调试游戏状态机**

游戏的核心流程（联机等待、玩家回合、游戏结束）是通过有限状态机（FSM）管理的 [2]。

  * **调试方法：** 在每个状态转换点（如`WAITING_FOR_PLAYER`到`PLAYER_TURN`）或事件处理函数中，添加详细的日志输出（`printf`或嵌入式日志系统）。
  * **关注点：** 确保网络数据接收事件、走子事件等，只会导致状态机进入预期的下一个状态，从而保证游戏逻辑的健壮性。

### **5.2 调试网络通信**

由于您使用了自定义的轻量级协议，网络调试至关重要。

  * **工具：** 在主机或客户端上使用网络抓包工具（如`tcpdump`或`Wireshark`）来捕获端口8888上的数据包。
  * **校验点：** 检查发送的数据包内容是否与您在C代码中定义的结构体（走子坐标、序列号等）完全匹配，以及TCP连接是否稳定建立和关闭 [1]。如果出现状态不同步，很可能是数据包解析错误或网络连接中断。
